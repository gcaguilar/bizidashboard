---
phase: 04-api-layer
plan: 03
type: execute
wave: 2
depends_on: [04-01]
files_modified: [src/app/api/patterns/route.ts, src/app/api/heatmap/route.ts, src/app/api/docs/route.ts]
autonomous: true

must_haves:
  truths:
    - "GET /api/patterns?stationId=... returns weekday/weekend hourly patterns"
    - "GET /api/heatmap?stationId=... returns occupancy heatmap cells"
    - "GET /api/docs serves OpenAPI JSON for all API endpoints"
  artifacts:
    - path: "src/app/api/patterns/route.ts"
      provides: "Patterns API endpoint"
      exports: ["GET"]
    - path: "src/app/api/heatmap/route.ts"
      provides: "Heatmap API endpoint"
      exports: ["GET"]
    - path: "src/app/api/docs/route.ts"
      provides: "OpenAPI JSON documentation"
      exports: ["GET"]
  key_links:
    - from: "src/app/api/patterns/route.ts"
      to: "src/analytics/queries/read.ts"
      via: "getStationPatterns"
      pattern: "getStationPatterns"
    - from: "src/app/api/heatmap/route.ts"
      to: "src/analytics/queries/read.ts"
      via: "getHeatmap"
      pattern: "getHeatmap"
    - from: "src/app/api/*/route.ts"
      to: "src/lib/cache/cache.ts"
      via: "cache helpers"
      pattern: "withCache|getCachedJson"
---

<objective>
Expose patterns, heatmap, and API documentation endpoints.

Purpose: Serve API-03, API-04, and API-06 docs requirements with cached responses.
Output: Patterns/heatmap route handlers and OpenAPI JSON at /api/docs.
</objective>

<execution_context>
@/home/guichu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/guichu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-api-layer/04-RESEARCH.md
@src/analytics/queries/read.ts
@src/app/api/status/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GET /api/patterns</name>
  <files>src/app/api/patterns/route.ts</files>
  <action>
Implement a Route Handler that requires `stationId` query param, validates presence, and returns 400 when missing. Call `getStationPatterns(stationId)` and wrap with Redis cache key `patterns:stationId={stationId}` and TTL 300 seconds. Set `dynamic = 'force-dynamic'` (or `revalidate = 0`) and include cache-control headers on success.
  </action>
  <verify>pnpm exec tsc --noEmit</verify>
  <done>Patterns endpoint returns station pattern rows with Redis cache-aside and proper status codes.</done>
</task>

<task type="auto">
  <name>Task 2: Create GET /api/heatmap</name>
  <files>src/app/api/heatmap/route.ts</files>
  <action>
Implement a Route Handler that requires `stationId` query param, validates presence, and returns 400 when missing. Call `getHeatmap(stationId)` and wrap with Redis cache key `heatmap:stationId={stationId}` and TTL 300 seconds. Set `dynamic = 'force-dynamic'` (or `revalidate = 0`) and include cache-control headers on success.
  </action>
  <verify>pnpm exec tsc --noEmit</verify>
  <done>Heatmap endpoint returns occupancy matrix rows with Redis cache-aside and proper status codes.</done>
</task>

<task type="auto">
  <name>Task 3: Serve OpenAPI JSON at /api/docs</name>
  <files>src/app/api/docs/route.ts</files>
  <action>
Return a static OpenAPI 3.2.0 JSON document describing all Phase 4 endpoints (`/api/stations`, `/api/rankings`, `/api/patterns`, `/api/heatmap`, `/api/alerts`). Include query parameters (`type`, `limit`, `stationId`) with types and required flags, plus 200/400/500 response shapes. Use `Response.json` or `NextResponse.json` and set `Content-Type: application/json`.
  </action>
  <verify>pnpm exec tsc --noEmit</verify>
  <done>GET /api/docs returns a valid OpenAPI JSON document covering all API endpoints and params.</done>
</task>

</tasks>

<verification>
- `pnpm exec tsc --noEmit`
</verification>

<success_criteria>
- `/api/patterns`, `/api/heatmap`, and `/api/docs` return JSON with proper status codes.
- Patterns and heatmap endpoints use cache-aside Redis with 5-minute TTL keys.
</success_criteria>

<output>
After completion, create `.planning/phases/04-api-layer/04-03-SUMMARY.md`
</output>
