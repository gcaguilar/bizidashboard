---
phase: 05-dashboard-frontend
plan: 03
type: execute
wave: 3
depends_on: ["02"]
files_modified: [src/app/dashboard/_components/MapPanel.tsx, src/app/dashboard/_components/StatusBanner.tsx, src/app/dashboard/_components/AlertsPanel.tsx, src/lib/format.ts]
autonomous: true

must_haves:
  truths:
    - "Mapa muestra estaciones con indicadores de ocupacion por color"
    - "Se ve la ultima actualizacion con minutos transcurridos"
    - "Alertas resaltan estaciones con pocas bicis o pocos anclajes"
  artifacts:
    - path: "src/app/dashboard/_components/MapPanel.tsx"
      provides: "Mapa de estaciones con marcadores codificados por color"
      exports: ["MapPanel"]
    - path: "src/app/dashboard/_components/StatusBanner.tsx"
      provides: "Indicador de ultima actualizacion y estado"
      exports: ["StatusBanner"]
    - path: "src/app/dashboard/_components/AlertsPanel.tsx"
      provides: "Lista de alertas activas con detalles"
      exports: ["AlertsPanel"]
  key_links:
    - from: "src/app/dashboard/_components/MapPanel.tsx"
      to: "maplibre-gl/dist/maplibre-gl.css"
      via: "import CSS"
      pattern: "maplibre-gl/dist/maplibre-gl.css"
    - from: "src/app/dashboard/_components/StatusBanner.tsx"
      to: "src/lib/format.ts"
      via: "formatRelativeMinutes"
      pattern: "formatRelativeMinutes"
    - from: "src/app/dashboard/_components/AlertsPanel.tsx"
      to: "src/lib/format.ts"
      via: "formatAlertType"
      pattern: "formatAlertType"
---

<objective>
Implementar mapa, estado y alertas con indicadores claros y en espanol.

Purpose: Mostrar la disponibilidad actual y las alertas criticas en el primer pantallazo del dashboard.
Output: Panel de mapa interactivo, indicador de ultima actualizacion y lista de alertas.
</objective>

<execution_context>
@/home/guichu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/guichu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-dashboard-frontend/05-RESEARCH.md
@src/app/dashboard/_components/DashboardClient.tsx
@src/app/dashboard/_components/MapPanel.tsx
@src/app/dashboard/_components/StatusBanner.tsx
@src/app/dashboard/_components/AlertsPanel.tsx
@src/lib/format.ts
@src/analytics/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implementar el mapa de estaciones con colores de ocupacion</name>
  <files>src/app/dashboard/_components/MapPanel.tsx</files>
  <action>
Convierte `MapPanel` en Client Component y usa `Map` y `Marker` de `react-map-gl/maplibre`. Importa `maplibre-gl/dist/maplibre-gl.css`. Configura `initialViewState` centrado en Zaragoza (lon -0.88, lat 41.65, zoom ~12). Renderiza un marcador por estacion con color segun ratio de ocupacion (`bikesAvailable / capacity`): rojo <= 0.2, amarillo <= 0.5, verde > 0.5. Muestra etiqueta pequena con nombre y disponibilidad al hover (tooltip simple). Si existe callback `onSelectStation`, permite seleccionar estacion al hacer click para alimentar el resto de paneles.
  </action>
  <verify>npm run lint</verify>
  <done>El mapa muestra estaciones con marcadores codificados por color y permite seleccionarlas.</done>
</task>

<task type="auto">
  <name>Task 2: Mostrar estado de ultima actualizacion y alertas</name>
  <files>src/app/dashboard/_components/StatusBanner.tsx, src/app/dashboard/_components/AlertsPanel.tsx, src/lib/format.ts</files>
  <action>
Implementa `StatusBanner` para mostrar "Actualizado hace X min" usando `formatRelativeMinutes` y la fecha mas reciente disponible (`status.quality.freshness.lastUpdated` o `generatedAt` de stations). Incluye un estado visual (verde/ambar/rojo) segun `status.pipeline.healthStatus`. En `AlertsPanel`, lista alertas activas con nombre de estacion (usa mapa de estaciones si viene en props), tipo en espanol (`formatAlertType`), valor y ventana de tiempo. Mantiene textos en espanol y estados vacios claros ("Sin alertas activas").
  </action>
  <verify>npm run lint</verify>
  <done>Status y alertas se muestran con textos en espanol, colores consistentes y datos reales.</done>
</task>

</tasks>

<verification>
- `npm run lint`
</verification>

<success_criteria>
- Mapa interactivo con indicadores de ocupacion por color.
- Indicador de ultima actualizacion visible y actualizado.
- Alertas activas listadas con contexto de estacion y tipo.
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard-frontend/05-03-SUMMARY.md`
</output>
