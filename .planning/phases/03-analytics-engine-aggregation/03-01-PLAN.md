---
phase: 03-analytics-engine-aggregation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/analytics/types.ts
autonomous: true

must_haves:
  truths:
    - "Aggregate tables for hourly and daily stats exist with station-linked keys"
    - "Aggregation watermarks and job locks can be stored in the database"
    - "Alert thresholds and window constants are centralized for reuse"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Hourly/daily aggregate models, derived analytics tables, and enums"
      contains: "model HourlyStationStat"
    - path: "src/analytics/types.ts"
      provides: "Analytics enums and thresholds used by rollups and alerts"
      exports: ["DayType", "AlertType", "ALERT_THRESHOLDS", "ANALYTICS_WINDOWS"]
  key_links:
    - from: "prisma/schema.prisma"
      to: "Station"
      via: "relation fields on aggregate tables"
      pattern: "stationId.*@relation"
---

<objective>
Define the analytics schema foundation and shared constants for rollups, rankings, and alerts.

Purpose: Ensure aggregate storage and thresholds exist before rollup jobs run.
Output: Updated Prisma schema with analytics tables and a shared analytics constants module.
</objective>

<execution_context>
@/home/guichu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/guichu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-analytics-engine-aggregation/03-RESEARCH.md
@docs/retention-ladder.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add analytics aggregate models and enums to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add Prisma enums and models for analytics aggregation:
- Enums: DayType (WEEKDAY, WEEKEND) and AlertType (LOW_BIKES, LOW_ANCHORS).
- HourlyStationStat: composite primary key (stationId, bucketStart), fields for bikes/anchors min/max/avg, occupancyAvg, sampleCount, timestamps, and station relation.
- DailyStationStat: composite primary key (stationId, bucketDate), fields for bikes/anchors min/max/avg, occupancyAvg, sampleCount, timestamps, and station relation.
- StationRanking: one row per station with turnoverScore, emptyHours, fullHours, totalHours, windowStart/windowEnd, updatedAt, and station relation.
- StationPattern: composite primary key (stationId, dayType, hour) with avg metrics and sampleCount.
- StationHeatmapCell: composite primary key (stationId, dayOfWeek, hour) with avg metrics and sampleCount.
- StationAlert: id, stationId, alertType, severity, metricValue, windowHours, generatedAt, isActive, and station relation.
- AnalyticsWatermark: name (id), lastAggregatedAt, updatedAt.
- JobLock: name (id), lockedAt, lockExpiresAt, lockedBy.
Ensure indexes on bucketStart/bucketDate and generatedAt for fast range queries. Keep all timestamps in UTC (no localtime modifiers).
  </action>
  <verify>npx prisma validate && npx prisma migrate dev --name analytics_aggregates</verify>
  <done>Prisma schema includes analytics tables/enums with composite keys and indexes; migration applies cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Create shared analytics types and thresholds</name>
  <files>src/analytics/types.ts</files>
  <action>
Create a new module exporting:
- TypeScript enums or string unions matching DayType and AlertType.
- ALERT_THRESHOLDS with lowBikes=5 and lowAnchors=3 (threshold-based alerts).
- ANALYTICS_WINDOWS with rankingDays=14 and alertWindowHours=3.
- Helper constants for rollup cutoffs (hourlyDelayMinutes=10, dailyDelayMinutes=90) used by cron scheduling.
Keep the module dependency-free so it can be imported from jobs and queries.
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Analytics constants and enums compile cleanly and are importable for later rollups.</done>
</task>

</tasks>

<verification>
Prisma migration applies and TypeScript compiles without errors.
</verification>

<success_criteria>
- Analytics aggregate schema exists with composite keys and indexes for rollup upserts.
- Shared thresholds and windows are defined in a single module for reuse.
</success_criteria>

<output>
After completion, create `.planning/phases/03-analytics-engine-aggregation/03-01-SUMMARY.md`
</output>
