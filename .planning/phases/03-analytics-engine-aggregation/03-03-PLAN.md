---
phase: 03-analytics-engine-aggregation
plan: 03
type: execute
wave: 3
depends_on: [03-02]
files_modified:
  - src/analytics/time-buckets.ts
  - src/analytics/queries/rankings.ts
  - src/analytics/queries/patterns.ts
  - src/analytics/queries/heatmap.ts
  - src/analytics/queries/alerts.ts
  - src/analytics/queries/read.ts
  - src/jobs/analytics-aggregation.ts
autonomous: true

must_haves:
  truths:
    - "Station ranking metrics for turnover and availability issues are materialized for the latest window"
    - "Weekday/weekend patterns and heatmap cells are precomputed in Europe/Madrid local time"
    - "Prediction alerts are generated from recent aggregates and stored as active alerts"
    - "Read helpers return analytics data without scanning StationStatus"
  artifacts:
    - path: "src/analytics/queries/rankings.ts"
      provides: "Turnover and availability ranking rollups"
    - path: "src/analytics/queries/patterns.ts"
      provides: "Weekday/weekend hourly patterns rollup"
    - path: "src/analytics/queries/heatmap.ts"
      provides: "Station heatmap rollup"
    - path: "src/analytics/queries/alerts.ts"
      provides: "Prediction alert generation"
    - path: "src/analytics/queries/read.ts"
      provides: "Read helpers for Phase 4 API layer"
  key_links:
    - from: "src/jobs/analytics-aggregation.ts"
      to: "src/analytics/queries/rankings.ts"
      via: "runRankingRollup"
      pattern: "runRankingRollup"
    - from: "src/analytics/queries/patterns.ts"
      to: "HourlyStationStat"
      via: "aggregate from hourly rollups"
      pattern: "HourlyStationStat"
    - from: "src/analytics/queries/read.ts"
      to: "StationStatus"
      via: "avoid raw table"
      pattern: "StationStatus"
---

<objective>
Materialize derived analytics (rankings, patterns, heatmap, alerts) and provide read helpers for the API layer.

Purpose: Ensure all Phase 3 analytics are precomputed and ready for fast API responses.
Output: Derived rollup modules, local-time bucketing helpers, and read helpers.
</objective>

<execution_context>
@/home/guichu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/guichu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-analytics-engine-aggregation/03-RESEARCH.md
@src/lib/timezone.ts
@src/analytics/queries/hourly.ts
@src/jobs/analytics-aggregation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add derived rollups for rankings, patterns, heatmap, and alerts</name>
  <files>src/analytics/time-buckets.ts, src/analytics/queries/rankings.ts, src/analytics/queries/patterns.ts, src/analytics/queries/heatmap.ts, src/analytics/queries/alerts.ts</files>
  <action>
Create a local-time bucketing helper that converts a UTC Date to Europe/Madrid local hour and day-of-week using Intl.DateTimeFormat with timeZone='Europe/Madrid'. Provide helpers for dayType (weekday/weekend).

Implement derived rollups using HourlyStationStat as the source (no StationStatus scans):
- Rankings: compute turnoverScore per station as sum((bikesMax - bikesMin) + (anchorsMax - anchorsMin)) over last ANALYTICS_WINDOWS.rankingDays; compute emptyHours/fullHours from bikesAvg <= 1 and anchorsAvg <= 1; upsert StationRanking with windowStart/windowEnd.
- Patterns: group hourly stats into StationPattern by stationId, dayType, hour (local time), aggregating avg bikes/anchors/occupancy and sampleCount; upsert by composite key.
- Heatmap: group hourly stats into StationHeatmapCell by stationId, dayOfWeek (0-6), hour (local time), aggregating avg metrics and sampleCount; upsert by composite key.
- Alerts: evaluate last alertWindowHours of hourly stats; create StationAlert rows when avg bikes < lowBikes or avg anchors < lowAnchors, set isActive=true and severity (e.g., bikes<2 or anchors<2 => severity 2).

Use UPSERT for all derived tables and ensure rollups are idempotent for the same window.
  </action>
  <verify>npm run lint</verify>
  <done>Derived analytics tables can be populated from hourly aggregates with local-time bucketing.</done>
</task>

<task type="auto">
  <name>Task 2: Wire derived rollups into analytics cron job</name>
  <files>src/jobs/analytics-aggregation.ts</files>
  <action>
Update the analytics cron job to:
- Run derived rollups after hourly rollup completes successfully.
- Pass the same cutoff window used for hourly rollups to keep data consistent.
- Update watermarks for ranking/pattern/heatmap rollups if needed (names: ranking_rollup, pattern_rollup, heatmap_rollup).
- Deactivate old alerts (set isActive=false) before inserting new active alerts.
Ensure derived rollups are skipped if the hourly rollup produced no new data.
  </action>
  <verify>npm run lint</verify>
  <done>Analytics cron job orchestrates derived rollups and maintains active alerts.</done>
</task>

<task type="auto">
  <name>Task 3: Add read helpers for Phase 4 API use</name>
  <files>src/analytics/queries/read.ts</files>
  <action>
Create read helpers that query precomputed tables only:
- getStationRankings(type, limit) reading StationRanking with orderBy turnoverScore or availability issues.
- getStationPatterns(stationId) returning StationPattern rows ordered by dayType and hour.
- getHeatmap(stationId) returning StationHeatmapCell rows ordered by dayOfWeek and hour.
- getActiveAlerts(limit) returning active StationAlert rows with latest generatedAt.
Ensure no reads from StationStatus in this module.
  </action>
  <verify>npm run lint</verify>
  <done>Read helpers return analytics data exclusively from aggregate tables.</done>
</task>

</tasks>

<verification>
Lint passes and analytics cron job compiles with derived rollup hooks.
</verification>

<success_criteria>
- Rankings, patterns, heatmap, and alerts are materialized from hourly aggregates.
- Local-time bucketing uses Europe/Madrid consistently for weekday/weekend splits.
- Read helpers are ready for Phase 4 API endpoints without raw table scans.
</success_criteria>

<output>
After completion, create `.planning/phases/03-analytics-engine-aggregation/03-03-SUMMARY.md`
</output>
