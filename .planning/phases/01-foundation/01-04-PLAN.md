# Phase 1, Plan 04 — Data Retention & CI/CD Setup

**Objective:** Document data retention ladder policy, configure CI/CD pipeline for automatic Prisma migrations, and create migration path documentation for future TimescaleDB upgrade.

**Purpose:** Prevent unbounded storage growth (Pitfall #1) by defining retention policies upfront. Ensure migrations run automatically in CI/CD to prevent schema drift between environments.

**Output:** Retention policy documentation, GitHub Actions workflow for migrations, and TimescaleDB migration guide.

**Type:** execute
**Wave:** 4
**Dependencies:** 01-02-PLAN.md (schema must be stable), 01-03-PLAN.md (timezone handling complete)
**Autonomous:** true

## Must-Haves

**Observable Truths:**
1. Data retention ladder documented: raw 30 days, hourly 1 year, daily forever
2. CI/CD workflow runs migrations automatically on deploy
3. Migration fails gracefully if database unreachable
4. TimescaleDB upgrade path documented for Phase 3+
5. Database backups configured before retention policies activate

**Required Artifacts:**
- `docs/retention-ladder.md` — Retention policy specification
- `.github/workflows/migrate.yml` — GitHub Actions CI/CD workflow
- `docs/timescaledb-migration.md` — Future migration guide
- `scripts/retention-cleanup.sql` — SQL for retention enforcement (Phase 3)

**Key Links:**
- Prisma schema → retention policies (which tables are affected)
- CI/CD workflow → DATABASE_URL secret
- Retention docs → implementation plan (when to add cleanup jobs)

## Tasks

### Task 1: Document Data Retention Ladder
**Type:** auto
**Priority:** MUST

**Action:**
Create docs/retention-ladder.md documenting the three-tier retention policy: raw StationStatus records (30 days), hourly aggregates (1 year), daily aggregates (forever). Include rationale, storage calculations, and implementation timeline.

**Document Structure:**
```markdown
# Data Retention Ladder

## Policy Overview

| Resolution | Retention Period | Storage Estimate | Implementation Phase |
|------------|------------------|------------------|---------------------|
| Raw (30-min) | 30 days | ~187k records | Phase 2 (collection) |
| Hourly aggregates | 1 year | ~1.1M records | Phase 3 (analytics) |
| Daily aggregates | Forever | ~365 records/year | Phase 3 (analytics) |

## Rationale

- **Raw data 30 days**: Sufficient for debugging and detailed analysis
- **Hourly 1 year**: Supports seasonal pattern analysis
- **Daily forever**: Long-term trend analysis and capacity planning

## Storage Calculations

- 130 stations × 48 readings/day = 6,240 records/day raw
- 6,240 × 30 days = 187,200 raw records
- Hourly: 130 × 24 = 3,120 records/day
- 3,120 × 365 days = 1,138,800 hourly records/year

## Implementation Timeline

- **Phase 1**: Schema supports timestamps, no cleanup yet
- **Phase 2**: Raw collection begins, 30-day retention via cron job
- **Phase 3**: Hourly/daily aggregates created, retention enforced
```

**Verification:**
- Document exists at docs/retention-ladder.md
- Storage calculations match 130 stations assumption
- Retention periods align with requirements
- Document reviewed for clarity

**Done When:**
- Retention policy documented
- Storage estimates calculated
- Implementation phases mapped

---

### Task 2: Configure CI/CD for Prisma Migrations
**Type:** auto
**Priority:** MUST

**Action:**
Create .github/workflows/migrate.yml that runs on push to main, executes `npx prisma migrate deploy` (for production), and validates schema with `npx prisma validate`. Use GitHub secrets for DATABASE_URL. Include health check step.

**Workflow Structure:**
```yaml
name: Database Migrations

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Validate schema
        run: npx prisma validate
      
      - name: Generate Prisma Client
        run: npx prisma generate
      
      - name: Deploy migrations (production only)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: npx prisma migrate deploy
      
      - name: Health check
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: npm run db:health
```

**Additional Files:**
- Add `db:health` script to package.json:
  ```json
  "scripts": {
    "db:health": "tsx scripts/db-health-check.ts"
  }
  ```
- Create `scripts/db-health-check.ts` to verify database connectivity and schema version

**Verification:**
- Workflow file valid (use actionlint or GitHub's parser)
- All steps have proper conditions
- Secrets referenced correctly
- Health check script exists and works locally

**Done When:**
- GitHub Actions workflow created
- db:health script implemented
- Workflow validates on PR, deploys on main push
- Secrets documentation created (for user setup)

---

### Task 3: Create TimescaleDB Migration Guide
**Type:** auto
**Priority:** SHOULD

**Action:**
Create docs/timescaledb-migration.md documenting the migration path from SQLite to TimescaleDB. Include: when to migrate (data volume thresholds), schema changes required (hypertables, continuous aggregates), data migration strategy, and deployment considerations.

**Document Structure:**
```markdown
# Migration Guide: SQLite → TimescaleDB

## When to Migrate

Migrate when ANY of these conditions are met:
- Raw data exceeds 1 million records (query slowdown)
- Analytics queries take >2 seconds consistently
- Need continuous aggregates (automatic refresh)
- Planning multi-year data retention

Timeline: Typically 3-6 months after Phase 3 launch.

## Schema Changes

### 1. Hypertable Conversion
```sql
-- Convert StationStatus to hypertable
SELECT create_hypertable('StationStatus', 'recordedAt');
```

### 2. Continuous Aggregates
```sql
-- Hourly aggregates (auto-refreshed)
CREATE MATERIALIZED VIEW hourly_station_stats
WITH (timescaledb.continuous) AS
SELECT ...
FROM StationStatus
GROUP BY time_bucket('1 hour', recordedAt), stationId;
```

### 3. Prisma Schema Updates
- Change provider from "sqlite" to "postgresql"
- Add TimescaleDB extension: `extensions = [timescaledb]`
- Update connection string format

## Data Migration Strategy

1. **Backup SQLite**: `cp dev.db dev.db.backup.$(date +%Y%m%d)`
2. **Export data**: Use `prisma db seed` or `sqlite3 .dump`
3. **Setup TimescaleDB**: Docker or managed service
4. **Import with Prisma**: `prisma db seed` with migration script
5. **Validate**: Compare record counts, run test queries

## Deployment

- Keep SQLite for local development
- Use TimescaleDB for production only (via DATABASE_URL)
- Environment-specific schema with conditional providers
```

**Verification:**
- Document exists at docs/timescaledb-migration.md
- Migration thresholds are specific
- Schema changes are detailed
- Data migration steps are clear

**Done When:**
- Migration guide created
- Thresholds defined for migration decision
- Schema transformation documented
- Rollback strategy included

## Verification

**Overall Phase 04 Verification:**
1. `docs/retention-ladder.md` exists with clear policy
2. `.github/workflows/migrate.yml` is valid YAML
3. `npm run db:health` works locally
4. `docs/timescaledb-migration.md` provides clear upgrade path
5. CI/CD workflow tested (via act locally if possible, or documented for user)

**CI/CD Validation:**
```bash
# Validate workflow syntax (if act is installed)
act -j migrate -n

# Or manual validation
# Push to test branch, verify workflow runs
```

## Success Criteria

- [ ] Data retention ladder documented with clear periods
- [ ] Storage calculations show expected growth
- [ ] CI/CD workflow validates schema on PR
- [ ] CI/CD workflow deploys migrations on main push
- [ ] Database health check script exists
- [ ] TimescaleDB migration guide includes:
  - [ ] Migration thresholds/triggers
  - [ ] Schema transformation steps
  - [ ] Data migration strategy
  - [ ] Deployment considerations
- [ ] Documentation explains when retention policies activate

## User Setup Required

**GitHub Secrets:**
- `DATABASE_URL`: Production database connection string
  - Format: `file:./prod.db` for SQLite (or postgres:// for TimescaleDB)
  - Location: GitHub Repository Settings → Secrets and variables → Actions

## Output

After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md` documenting:
- Retention policy details
- CI/CD workflow configuration
- TimescaleDB migration roadmap
- Any deployment-specific notes

---

**Estimated Context Usage:** ~35%
**Estimated Execution Time:** 45-60 minutes
